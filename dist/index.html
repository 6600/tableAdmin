<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <!-- 页面的元信息 -->
  <title>苏州斯百特教育财务平台</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=1000, user-scalable=yes" />
  <meta name="format-detection" content="telephone=no, email=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="white" />
  <meta name="renderer" content="webkit" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="filetype" content="1" />
  <meta name="publishedtype" content="1" />
  <meta name="pagetype" content="2" />
  <meta name="description" content="{TAG_59447_TAG}" />
  <meta name="keywords" content="{TAG_59446_TAG}" />
  <meta name="catalogs" content="{TAG_83943_TAG}" />

  <!-- 页面主样式文件 -->
  <link charset="utf-8" rel="stylesheet" href="./static/css/owo.core.68cujg73nmn.css">

  <!-- 附属css文件 -->
  <link rel="stylesheet" href="./static/css/main.css" charset="utf-8">

</head>

<body>

  <!-- 页面[login]-->
  <div class="login page" template="login" style="display: none;">
    <div class="router" view="loginContent">
      <div class="view-login" route="login">
        <div class="image-box">
          <img src="./static/resource/8c8aa8829608aa383dd9a6c631fa07b.jpg">
        </div>
        <div class="hellow-text">登录苏州斯百特教育财务平台</div>
        <div class="user-name-bar input-bar">
          <img class="bar-icon" src="https://cunchu.site/puge/login/user.png">
          <input type="text" o-value="this.data.username" placeholder="用户名">
        </div>
        <div class="pass-word-bar input-bar">
          <img class="bar-icon" src="https://cunchu.site/puge/login/password.png">
          <input type="password" o-value="this.data.password" placeholder="密码">
        </div>
        <div class="button-box">
          <div class="button" o-tap="login" o-hover="radial-out">登录</div>
          <div class="button" o-hover="radial-out" style=" background-color: burlywood;" go="/view-loginContent=register">注册</div>
        </div>
        <div class="tool-bar">
          <div class="left"></div>
          <div class="right" go-route="">忘记密码</div>
        </div>
      </div>
      <div class="view-register" route="register">
        <img class="bg-1" src="https://cunchu.site/puge/login/art.png">
        <p>欢迎注册PUGE账号</p>
        <input class="register-input" type="text" o-value="this.data.registerusername" placeholder="用户名">
        <input class="register-input" type="password" o-value="this.data.registerPassWord" placeholder="密码">
        <input class="register-input" type="password" o-value="this.data.registerPassWordR" placeholder="确认密码">
        <div class="mini-box clear">
          <input class="register-input" type="text" o-value="this.data.registerPhone" placeholder="手机号码">
          <div class="button" o-tap="sendSMS">发送验证码</div>
        </div>
        <input class="register-input" type="text" o-value="this.data.registerCode" placeholder="验证码">
        <div class="button" o-tap="register">注册</div>
      </div>
    </div>
  </div>
  <!-- 页面[page]-->
  <div class="home page" template="page" style="display: none;">
    <div class="title">
      <span>用户管理</span>
      <span>
        <a class="admin" href="#user" style="display: none;">后台管理</a>
        <a href="#">退出登录</a>
      </span>
    </div>
    <div class="tab-bar"></div>
    <div class="conn">
      <div class="table-box"></div>
    </div>
  </div>
  <!-- 页面[user]-->
  <div class="user page" template="user" style="display: none;">
    <div class="title">
      <span>后台管理</span>
      <span>
        <a href="#page">表格查看</a>
        <a href="#">退出登录</a>
      </span>
    </div>
    <div class="conn">
      <h3>权限管理</h3>
      <div class="table-box"></div>
      <h3>密码管理</h3>
      <div class="password-box">
        <div class="password-item">
          <table border="0">
            <tbody>
              <tr>
                <th>用户名</th>
                <th>密码</th>
              </tr>
              <tr o-for="owo.state.userInfo.sub">
                <th>
                  <input class="pass-input" type="text" value="{key}" onchange="changePN('{key}', event)">
                </th>
                <th>
                  <input class="pass-input" type="text" value="{value.password}" onchange="changePW('{key}', event)">
                </th>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <h3>表格管理</h3>
      <div class="table-box-2">
        <table border="0">
          <tbody>
            <tr o-for="owo.state.userInfo.data">
              <th>
                <input class="pass-input" type="text" value="{value.name}" onchange="owo.state.userInfo.data[{key}].name = event.target.value">
              </th>
              <th>
                <span o-tap="deleteTable('{key}')">删除表格</span>
              </th>
            </tr>
          </tbody>
        </table>
        <div class="button-box">
          <div class="button" o-tap="saveUserInfo()">保存设置</div>
          <div class="button" o-tap="addTable">添加表格</div>
        </div>
      </div>
    </div>
  </div>

  <!-- 框架script文件 -->
  <script src="./static/js/owo.core.68cujg73nmn.js" type="text/javascript" charset="UTF-8"></script>
  <script type="text/javascript" charset="UTF-8">
    // 模块 login 的script代码
    var appType = '苏州斯百特教育财务平台'; // var userInfo = localStorage.getItem("owoUserInfo_" + appType)
    // if (userInfo) {
    //   console.log(userInfo)
    //   owo.state.userInfo = JSON.parse(userInfo)
    //   if (typeof owo.state.userInfo.data == "string") {
    //     if (owo.state.userInfo.data == '') owo.state.userInfo.data = {}
    //     else owo.state.userInfo.data = JSON.parse(owo.state.userInfo.data)
    //   }
    //   // getDataFormSession(owo.state.userInfo.username, owo.state.userInfo.session)
    // }

    function getDataFormSession(username, session) {
      fetch("http://going.run/userServer?route=loginSession", {
        method: 'POST',
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          type: appType,
          username: username,
          session: session
        })
      }).then(function(response) {
        return response.json();
      }).then(function(res) {
        console.log(res);

        if (res.err === 0) {
          owo.tool.toast('登陆成功');
          owo.state.userInfo = res.data; // localStorage.setItem('owoUserInfo_' + appType, JSON.stringify(res.data))

          if (owo.event.login) {
            owo.event.login(res.data);
          }
        } else {
          owo.go('login');
          owo.tool.toast(res.message);
        }
      });
    } // 模块 page 的script代码


    owo.event.login = function() {
      owo.script.page.createdTable(0);
    }; // 模块 user 的script代码


    function changeP(name, event) {
      var isChecked = event.target.checked;
      var powerName = event.target.value;

      if (isChecked) {
        owo.state.userInfo.sub[name].power[powerName] = true;
      } else {
        owo.state.userInfo.sub[name].power[powerName] = false;
      }

      console.log(owo.state.userInfo.sub);
      saveUserSub(owo.state.userInfo.sub);
    }

    function changePW(name, event) {
      owo.state.userInfo.sub[name].password = event.target.value;
      console.log(owo.state.userInfo.sub);
      saveUserSub(owo.state.userInfo.sub);
    }

    function changePN(name, event) {
      owo.state.userInfo.sub[event.target.value] = owo.state.userInfo.sub[name];
      delete owo.state.userInfo.sub[name];
      console.log(owo.state.userInfo.sub);
      saveUserSub(owo.state.userInfo.sub);
    }

    owo.script = {
      "login": {
        "data": {
          "registerusername": "",
          "registerPassWord": "",
          "registerPassWordR": "",
          "registerPhone": "",
          "registerCode": "",
          "username": "test",
          "password": "Gsyugj85eoAebnzN",
          "toast": null,
          "session": null
        },
        "created": function created() {
          if (owo.tool.toast) toast = owo.tool.toast;
          else toast = alert;
        },
        "login": function login() {
          var getUrl = "http://going.run/userServer?route=login";

          if (this.data.username !== 'test') {
            getUrl = "http://going.run/userServer?route=loginSub";
          }

          fetch(getUrl, {
            method: 'POST',
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              type: appType,
              username: 'test',
              subname: this.data.username,
              password: this.data.password
            })
          }).then(function(response) {
            return response.json();
          }).then(function(res) {
            console.log(res);

            if (res.err === 0) {
              toast('登陆成功'); // do something

              owo.state.userInfo = res.data; // localStorage.setItem('owoUserInfo_' + appType, JSON.stringify(res.data))

              setTimeout(function() {
                owo.go('page');
              }, 0);
            } else {
              toast(res.message);
            }
          });
        },
        "register": function register() {
          if (!this.data.registerusername) {
            toast('用户名不能为空哦!');
            return;
          }

          if (!this.data.registerPassWord) {
            toast('密码不能为空哦!');
            return;
          }

          if (!this.data.registerPassWordR) {
            toast('重复密码不能为空哦!');
            return;
          }

          if (!this.data.registerPhone) {
            toast('手机号码不能为空!');
            return;
          }

          if (this.data.registerPassWord !== this.data.registerPassWordR) {
            toast('两次输入的密码不一致哦!');
            return;
          }

          fetch("http://going.run/userServer?route=register", {
            method: 'POST',
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              phone: this.data.registerPhone,
              username: this.data.registerusername,
              password: this.data.registerPassWord,
              code: this.data.registerCode
            })
          }).then(function(response) {
            return response.json();
          }).then(function(res) {
            if (res.err === 0) {
              toast('注册成功!');
              owo.go('/view-loginContent=login');
            } else {
              toast("\u6CE8\u518C\u5931\u8D25: " + res.message);
            }
          });
        },
        "sendSMS": function sendSMS() {
          if (!this.data.registerPhone) {
            alert('手机号码不能为空!');
            return;
          }

          fetch("http://going.run/userServer?route=sendSMS", {
            method: 'POST',
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              phone: this.data.registerPhone
            })
          }).then(function(response) {
            return response.json();
          }).then(function(res) {
            if (res.err === 0) {
              toast('短信已发送!');
            } else {
              toast("\u77ED\u4FE1\u53D1\u9001\u5931\u8D25: " + res.message);
            }
          });
        },
        "view": {
          "loginContent": [{
            "_name": "login",
            "_inherit": true
          }, {
            "_name": "register",
            "_inherit": true
          }]
        }
      },
      "page": {
        "data": {
          "activeIndex": 0,
          "mockData": [{
            "name": "表格1",
            "data": [{
              "name": "初级",
              "value": [0, 0, 0, 0, 0, 0]
            }, {
              "name": "人保三级",
              "value": [0, 0, 0, 0, 0, 0]
            }, {
              "name": "人保四级",
              "value": [0, 0, 0, 0, 0, 0]
            }, {
              "name": "新版证书",
              "value": [0, 0, 0, 0, 0, 0]
            }, {
              "name": "河北保安员三级",
              "value": [0, 0, 0, 0, 0, 0]
            }, {
              "name": "安监员",
              "value": [0, 0, 0, 0, 0, 0]
            }]
          }, {
            "name": "表格2",
            "data": [{
              "name": "初级2",
              "value": [0, 0, 0, 0, 0, 0]
            }, {
              "name": "人保三级2",
              "value": [0, 0, 0, 0, 0, 0]
            }, {
              "name": "人保四级2",
              "value": [0, 0, 0, 0, 0, 0]
            }, {
              "name": "新版证书",
              "value": [0, 0, 0, 0, 0, 0]
            }, {
              "name": "河北保安员三级",
              "value": [0, 0, 0, 0, 0, 0]
            }, {
              "name": "安监员",
              "value": [0, 0, 0, 0, 0, 0]
            }]
          }],
          "timer": null
        },
        "show": function show() {
          var _this = this;

          if (!owo.state.userInfo) {
            setTimeout(function() {
              owo.go('login');
            }, 100);
            return;
          }

          if (owo.state.userInfo.username == 'test') {
            this.query('.admin').style.display = 'inline';
          } else {
            this.query('.admin').style.display = 'none';
          }

          setTimeout(function() {
            _this.createdTab(owo.state.userInfo.data);
          }, 100);
        },
        "createdTab": function createdTab(data) {
          var _this2 = this;

          var tabHTML = "";
          var ind = 0;
          data.forEach(function(element) {
            if (element) {
              tabHTML += "<div class=\"tab-bar-item\" o-tap=\"createdTable(" + ind + ")\">" + element.name + "</div>";
            }

            ind++;
          }); // tabHTML += `<div class="tab-bar-item" o-tap="addTable">+</div>`

          this.query('.tab-bar').innerHTML = tabHTML;
          this.createdTable(0);
          setTimeout(function() {
            _this2.handleEvent(_this2, _this2.query('.tab-bar'));
          }, 100);
        },
        "createdTable": function createdTable(ind) {
          var _this3 = this;

          this.data.activeIndex = ind;
          ind = parseInt(ind);
          var data = owo.state.userInfo.data[ind].data;
          this.queryAll('.tab-bar-item').forEach(function(element) {
            element.classList.remove('active');
          });
          this.queryAll('.tab-bar-item')[ind].classList.add('active');
          var newHtml = '<img class="add-line" o-tap="addline" src="./static/resource/add.svg"><img class="add-line2" o-tap="addline2" src="./static/resource/add.svg"><table border="0" contenteditable="true"><tr>';
          data.forEach(function(item) {
            newHtml += "<th>" + item.name + "</th>";
          });
          newHtml += "</tr>"; // 获取最大的表项

          console.log(data);
          var lineNumber = data.length;
          var rowNumber = 0;
          data.forEach(function(element) {
            if (element.value.length > rowNumber) rowNumber = element.value.length;
          });

          for (var index = 0; index < rowNumber; index++) {
            var temp = data[index] ? data[index].value : [];
            newHtml += "<tr>";

            for (var index2 = 0; index2 < lineNumber; index2++) {
              var element = temp[index];
              var value = data[index2].value[index] == undefined ? '' : data[index2].value[index];
              newHtml += "<td o-mouseout=\"saveData(" + ind + ", '" + index2 + "', " + index + ")\">" + value + "</td>";
            }

            newHtml += "</tr>";
          }

          newHtml += "</table>";
          this.query('.table-box').innerHTML = newHtml;
          setTimeout(function() {
            _this3.handleEvent(_this3, _this3.query('.table-box'));
          }, 100);
        },
        "saveData": function saveData(key, name, index) {
          if (owo.state.userInfo.data[key].data[name].value[index] != this.$target.innerText) {
            owo.state.userInfo.data[key].data[name].value[index] = this.$target.innerText;
            saveUserInfo();
          }
        },
        "addline": function addline() {
          var temp = owo.state.userInfo.data[this.data.activeIndex];
          temp.data.push({
            "name": "新增项",
            "value": Array(temp.row)
          }); // console.log(owo.state.userInfo.data[this.data.activeIndex])

          this.createdTable(this.data.activeIndex);
        },
        "addline2": function addline2() {
          var temp = owo.state.userInfo.data[this.data.activeIndex].data;
          console.log(owo.state.userInfo.data[this.data.activeIndex]);
          temp[0].value.push('');
          this.createdTable(this.data.activeIndex);
        },
        "saveTab": function saveTab(ind) {
          owo.state.userInfo.data[ind].name = this.$target.innerText;
          this.createdTable(this.data.activeIndex);
        },
        "addTable": function addTable() {
          owo.state.userInfo.data.push({
            name: "新建表格",
            data: [{
              "name": "表项1",
              "value": [0, 0, 0, 0, 0, 0]
            }, {
              "name": "表项2",
              "value": [0, 0, 0, 0, 0, 0]
            }, {
              "name": "表项3",
              "value": [0, 0, 0, 0, 0, 0]
            }]
          });
          this.createdTab(owo.state.userInfo.data);
        },
        "stopAutoGet": function stopAutoGet() {
          window.clearInterval(this.data.timer);
        },
        "startAutoGet": function startAutoGet() {
          window.clearInterval(this.data.timer);
          this.data.timer = setInterval(function() {
            fetch("http://going.run/userServer?route=loginSession", {
              method: 'POST',
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                type: appType,
                username: owo.state.userInfo.username,
                session: owo.state.userInfo.session
              })
            }).then(function(response) {
              return response.json();
            }).then(function(res) {
              console.log(res);

              if (res.err === 0) {} else {
                owo.go('login');
                owo.tool.toast(res.message);
              }
            });
          }, 5000);
        }
      },
      "user": {
        "show": function show() {
          var _this4 = this;

          if (!owo.state.userInfo) {
            setTimeout(function() {
              owo.go('login');
            }, 100);
            return;
          }

          setTimeout(function() {
            var newHtml = '<table border="0"><tr><th></th>';
            console.log(owo.state.userInfo.data);
            owo.state.userInfo.data.forEach(function(item) {
              if (item) {
                newHtml += "<th>" + item.name + "</th>";
              }
            });
            newHtml += "</tr>";
            var sub = owo.state.userInfo.sub;

            var _loop = function _loop(key) {
              if (Object.hasOwnProperty.call(sub, key)) {
                var element = sub[key];
                newHtml += "<tr><th>" + key + "</th>";
                owo.state.userInfo.data.forEach(function(item) {
                  if (item) {
                    if (element.power[item.name]) {
                      newHtml += "<th><input type=\"checkbox\" name=\"category\" onchange=\"changeP('" + key + "', event)\" value=\"" + item.name + "\" checked=\"true\"/></th>";
                    } else {
                      newHtml += "<th><input type=\"checkbox\" name=\"category\" onchange=\"changeP('" + key + "', event)\" value=\"" + item.name + "\"/></th>";
                    }
                  }
                });
                newHtml += "</tr>";
              }
            };

            for (var key in sub) {
              _loop(key);
            }

            newHtml += "</table>";
            _this4.query('.table-box').innerHTML = newHtml;
          }, 100);
        },
        "addTable": function addTable() {
          var _this5 = this;

          owo.state.userInfo.data.push({
            name: "新建表格",
            data: [{
              "name": "表项1",
              "value": [0, 0, 0, 0, 0, 0]
            }, {
              "name": "表项2",
              "value": [0, 0, 0, 0, 0, 0]
            }, {
              "name": "表项3",
              "value": [0, 0, 0, 0, 0, 0]
            }]
          });
          saveUserInfo();
          setTimeout(function() {
            _this5.show();
          }, 100);
        },
        "deleteTable": function deleteTable(key) {
          var _this6 = this;

          delete owo.state.userInfo.data[key];
          saveUserInfo();
          setTimeout(function() {
            _this6.show();
          }, 100);
        }
      }
    };
  </script>

  <script src="./static/js/main.js" type="text/javascript" charset="UTF-8"></script>
  <script src="https://cunchu.site/owo/script/jquery-1.11.1.min.js" type="text/javascript" charset="UTF-8"></script>

  <script src="./static/js/toast.js" type="text/javascript" charset="UTF-8"></script>
</body>

</html>